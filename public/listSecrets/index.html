<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Secrets</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">


    <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap');

*{
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.login-body {
  font-family: 'Poppins', sans-serif;
  height: 100vh;
  width: 100vw;
  background-color: #7227D5;
  display:flex;
  justify-content: center;
  align-items: center;
}

.card{
  background: #fff;
  width: 900px;
  min-height: 400px;
  box-shadow: rgba(50, 50, 93, 0.25) 0px 6px 12px -2px, rgba(0, 0, 0, 0.3) 0px 3px 7px -3px;
  display: flex;
  flex-direction: row;
}

.form,
.image{
  width: 50%;
}

.image{
  background-size:cover;
  background-position: center;
}

.overlay{
  width: 100%;
  height: 100%;
  background-color: rgba(114, 39, 213, 0.31);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  text-align: center;
  
}

.overlay h3{
  color:white;
  letter-spacing: 1px;
  font-size: 25px;
  font-weight: 700;
  opacity: 0.6;
}
.overlay p{
  color:white;
  font-size: 13px;
  font-weight: bold;
   opacity: 0.6;
}


.form{
  padding: 60px 25px; 
  display: flex;
  flex-direction: column;
}
.form h3{
  font-size: 28px;
  font-weight: 500;
  position: relative;
  margin-bottom: 30px;
}
.form h3::after{
  content: '';
  width:30px;
  height:3px;
  background: #7227D5;
  position: absolute;
  left: 0;
  bottom: 2px;
  border-radius: 5px;
}

.fa{
  color: #7227D5;
  position: absolute;
  top:10px;
  font-size: 18px;
}

.input-field{
  width: 100%;
  margin-bottom: 10px;
  position: relative;
}
.input-field input{
  display: block; 
  width: 100%;
  padding: 10px 30px;
  outline: none;
  border:none;
  border-bottom: 2px solid rgb(182, 180, 180);
  font-size: 15px;
}

.form>a{
  color:#7227D5;
  text-decoration: none;
  font-size: 14px;
  margin-bottom: 35px
}

button{
  height: 45px;
  background:#7227D5;
  border:none;
  color:white;
  border-radius: 5px;
  font-size: 18px;
}

button+p{
  text-align: center;
  padding-top: 30px;
  font-size: 14px;
}

button+p a{
  text-decoration: none;
  color:#7227D5;
  font-weight: 500;
}

input::placeholder {
  font-family: 'Poppins', sans-serif;
}

.login-btn {
  cursor: pointer;
}

.no-grey-disabled:disabled {
    background-color: #ffffff; /* Or your desired background color */
    opacity: 1; /* Ensure full opacity */
    cursor: default; /* Change cursor if needed */
}





@keyframes growFont {
    from { font-size: 1rem; }
    to { font-size: 20rem; }
}

.animator {
    animation-name: growFont; /* Defines the @keyframes rule to use */
    animation-duration: .3s; /* Duration of one animation cycle */
    animation-iteration-count: infinite; /* Repeats indefinitely */
    animation-direction: alternate; /* Alternates direction each cycle */
    animation-timing-function: ease-in-out; /* Optional: Controls animation speed curve */
}

.header-contents select {
  height: 45px;
}

.header-contents {
  border-bottom: 3px solid #ccc;
}

input:disabled {
  background: white !important;
}

.alert-container {
  position: absolute;
  top: 0;
  right: 0;
  z-index: 1050;
}

.item-detail-contents input::placeholder, .create-item-modal-content input::placeholder, .create-user-modal-content input::placeholder {
  color: black  ;
}

.confirmation-content {
  font-weight: bold;
  font-size: 20px;
}

.popover-header {
  font-weight: bold;
  font-size: 20px;
}

.btn-circle {
  border-radius: 50%;
}

.actions-menu {
  display: none;
  position: fixed;
  right: 0;
  height: 90%;
  z-index: 500;
  width: 100%;
  background: white;
  text-align: right;
  padding-right: 10px;
  overflow: auto;
}

.actions-menu button {
  border-radius: 48%;
  width: 250px;
}

.header-badge {
  font-size: 150%;
}


[id^="otherFieldsKeyTooltip"] {
  background: #333;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 13px;
  display: none; 
  transform: none !important;
}


[id^="otherFieldsKeyTooltip"][data-show] {
  display: block;
}
</style>
  </head>
  <body>
    <div id="loader" style="display: block;" class="min-vh-100 d-flex justify-content-center align-items-center animator">
      <div class="centered-div">
        <i class="bi bi-shield-lock-fill"></i>
        <i class="bi bi-incognito"></i>
      </div>
    </div>

    <div id="contents" style="display: none;" class="min-vh-100 d-flex justify-content-center align-items-center">
      <div class="container-fluid">
        <div class="row h-100 align-items-center">
          <div class="col">
            <div class="row justify-content-between header-contents">
              <div class="col-auto">
                <span class="header-badge badge badge-pill badge-primary">Folder</span>
                <select id="folderSelect" class="form-select form-select-lg mb-2 custom-select w-auto" aria-label=".form-select-lg example" onchange="folderChanged()">
                </select>
                <span class="header-badge badge badge-pill badge-primary">Item</span>
                <select id="itemSelect" class="form-select form-select-lg mb-2 custom-select w-auto" aria-label=".form-select-lg example" onchange="itemChanged()">
                </select>
              </div>
              <div class="col-auto">
                <button id="actionsMenuBtn" class="btn btn-primary btn-circle" onClick="toggleActionsMenu()"><i class="bi bi-filter-circle"></i></button>
                <div id="actionsMenu" class="actions-menu" onClick="toggleActionsMenu()">

                  <div class="container-fluid">
                    <div class="row h-100 align-items-center">
                      <div class="col">
                        <div class="row justify-content-between header-contents">
                          <div class="col-auto">
                            <button id="editFolderBtn" type="button" class="btn btn-success mb-3 mt-2" onClick="openCreateFolderModal(true)">
                              <i class="bi bi-pencil-square"></i> Edit Selected Folder
                            </button>
                            <br/>
                            <button
                              id="deleteFolderBtn"
                              type="button"
                              class="btn btn-danger mb-3 mt-2"
                              data-singleton="true"
                              data-toggle="confirmation"
                              data-btn-ok-label="DELETE"
                              data-btn-ok-class="btn btn-danger"
                              data-btn-ok-icon-class="bi bi-trash"
                              data-btn-cancel-label="NO"
                              data-btn-cancel-class="btn btn-success"
                              data-btn-cancel-icon-class="bi bi-check"
                              data-title="ARE YOU SURE?"
                              data-content="The folder will be permanently deleted, along with all the items inside it. This action can never be undone!!"
                              data-popout="true"
                            >
                              <i class="bi bi-trash"></i> Delete Selected Folder
                            </button>
                            <br/>
                            <button id="createFolderBtn" type="button" class="btn btn-success mb-3 mt-2" onClick="openCreateFolderModal()">
                              <i class="bi bi-plus"></i> Create Folder
                            </button>
                          </div>
                          <div class="col-auto">
                            <button id="editItemBtn" type="button" class="btn btn-success mb-3 mt-2" onClick="openCreateItemModal(true)">
                              <i class="bi bi-pencil-square"></i> Edit Selected Item
                            </button>
                            <br/>
                            <button
                              id="deleteItemBtn"
                              type="button"
                              class="btn btn-danger mb-3 mt-2"
                              data-singleton="true"
                              data-toggle="confirmation"
                              data-btn-ok-label="DELETE"
                              data-btn-ok-class="btn btn-danger"
                              data-btn-ok-icon-class="bi bi-trash"
                              data-btn-cancel-label="NO"
                              data-btn-cancel-class="btn btn-success"
                              data-btn-cancel-icon-class="bi bi-check"
                              data-title="ARE YOU SURE?"
                              data-content="This item will be permanently deleted. This action can not be undone!!"
                              data-popout="true"
                            >
                              <i class="bi bi-trash"></i> Delete Selected Item
                            </button>
                            <br/>
                            <button id="createItemBtn" type="button" class="btn btn-success mb-3 mt-2" onClick="openCreateItemModal()">
                              <i class="bi bi-plus"></i> Create Item
                            </button>
                          </div>
                          <div class="col-auto">
                            <button id="editUserBtn" type="button" class="btn btn-info mb-3 mt-2" onClick="openCreateUserModal(true)"><i class="bi bi-pencil-square"></i> Edit Current User</button>
                            <br/>
                            <button id="createUserBtn" type="button" class="btn btn-info mb-3 mt-2" onClick="openCreateUserModal()"><i class="bi bi-plus"></i> Create User</button>
                            <br/>
                            <button type="button" class="btn btn-info mb-3 mt-2" onClick="logOut()"><i class="bi bi-box-arrow-right"></i>Logout</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row justify-content-left p-3 item-detail-contents">
                <div class="container-fluid">
                  <div class="row h-100 align-items-center">
                    <div class="col">
                      <div class="row justify-content-between">
                        <div class="input-group input-group-lg">
                          <span class="input-group-text"><i class="bi bi-database-fill"></i></span>
                          <input type="text" disabled class="form-control" id="itemDetailTitle">
                          <button class="btn btn-success" onclick="copyItemTitle()"><i class="bi bi-copy"></i></button>
                        </div>
                      </div>
                      <div class="row justify-content-between">
                        <div class="input-group input-group-lg">
                          <span class="input-group-text"><i class="bi bi-person-bounding-box"></i></span>
                          <input type="text" disabled class="form-control" id="itemDetailUsername">
                          <button class="btn btn-success" onclick="copyItemUserName()"><i class="bi bi-copy"></i></button>
                        </div>
                      </div>
                      <div class="row justify-content-between">
                        <div class="input-group input-group-lg">
                          <span class="input-group-text"><i class="bi bi-lock"></i></span>
                          <input type="text" disabled placeholder="******" class="form-control" id="itemDetailPassword">
                          <button class="btn btn-primary" onclick="showPassword()"><i class="bi bi-eye-slash"></i></button>
                          <button class="btn btn-success" onclick="copyItemPassword()" id="itemDetailCopyPassword"><i class="bi bi-copy"></i></button>
                        </div>
                      </div>
                      <div class="row justify-content-between">
                        <hr class="container-fluid bg-danger border-2 border-top border-danger" />
                      </div>
                      <div class="row justify-content-between">
                        <h3>Other Fields:</h3>
                      </div>
                      <span id="itemDetailOtherFields">
                      </span>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="createFolderModal" role="dialog">
    </div>

    <div class="modal" id="createUserModal" role="dialog">
    </div>

    <div class="modal" id="createItemModal" role="dialog">
    </div>

    <div id="loginAlertContainer" class="alert-container">
    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


    <script>
/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/bootstrap-confirmation2@4.2.1/dist/bootstrap-confirmation.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/*!
 * Bootstrap Confirmation (v4.2.1)
 * @copyright 2013 Nimit Suwannagate <ethaizone@hotmail.com>
 * @copyright 2014-2021 Damien "Mistic" Sorel <contact@git.strangeplanet.fr>
 * @licence Apache License, Version 2.0
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("jquery"),require("bootstrap")):"function"==typeof define&&define.amd?define(["jquery","bootstrap"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).jQuery)}(this,(function(t){"use strict";function e(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(){return n=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},n.apply(this,arguments)}function o(t,e){return o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},o(t,e)}if(void 0===t.fn.popover||"4"!==t.fn.popover.Constructor.VERSION.split(".").shift())throw new Error("Bootstrap Confirmation 4 requires Bootstrap Popover 4");var i=t.fn.popover.Constructor,r="confirmation",s="bs."+r,c="."+s,a=t.fn[r],l="btn btn-sm",f=n({},i.DefaultType,{singleton:"boolean",popout:"boolean",copyAttributes:"(string|array)",onConfirm:"function",onCancel:"function",btnOkClass:"string",btnOkLabel:"string",btnOkIconClass:"string",btnOkIconContent:"string",btnCancelClass:"string",btnCancelLabel:"string",btnCancelIconClass:"string",btnCancelIconContent:"string",buttons:"array"}),u=n({},i.Default,{_attributes:{},_selector:null,placement:"top",title:"Are you sure?",trigger:"click",confirmationEvent:void 0,content:"",singleton:!1,popout:!1,copyAttributes:"href target",onConfirm:t.noop,onCancel:t.noop,btnOkClass:l+" btn-primary",btnOkLabel:"Yes",btnOkIconClass:"",btnOkIconContent:"",btnCancelClass:l+" btn-secondary",btnCancelLabel:"No",btnCancelIconClass:"",btnCancelIconContent:"",buttons:[],template:'\n<div class="popover confirmation">\n  <div class="arrow"></div>\n  <h3 class="popover-header"></h3>\n  <div class="popover-body">\n    <p class="confirmation-content"></p>\n    <div class="confirmation-buttons text-center">\n      <div class="btn-group"></div>\n    </div>\n  </div>\n</div>'});u.whiteList&&u.whiteList["*"].push("data-apply","data-dismiss");var h,p="fade",g="show",d=".popover-header",b=".confirmation-content",C=".confirmation-buttons .btn-group",v={13:"Enter",27:"Escape",39:"ArrowRight",40:"ArrowDown"},y={HIDE:"hide"+c,HIDDEN:"hidden"+c,SHOW:"show"+c,SHOWN:"shown"+c,INSERTED:"inserted"+c,CLICK:"click"+c,FOCUSIN:"focusin"+c,FOCUSOUT:"focusout"+c,MOUSEENTER:"mouseenter"+c,MOUSELEAVE:"mouseleave"+c,CONFIRMED:"confirmed"+c,CANCELED:"canceled"+c,KEYUP:"keyup"+c},m=function(i){var a,m;function E(t,e){var n;if(((n=i.call(this,t,e)||this).config.popout||n.config.singleton)&&!n.config.rootSelector)throw new Error("The rootSelector option is required to use popout and singleton features since jQuery 3.");return n._isDelegate=!1,e.selector?(e._selector=e.rootSelector+" "+e.selector,n.config._selector=e._selector):e._selector?(n.config._selector=e._selector,n._isDelegate=!0):n.config._selector=e.rootSelector,void 0===n.config.confirmationEvent&&(n.config.confirmationEvent=n.config.trigger),n.config.selector||n._copyAttributes(),n._setConfirmationListeners(),n}m=i,(a=E).prototype=Object.create(m.prototype),a.prototype.constructor=a,o(a,m);var _,O,I,k=E.prototype;return k.isWithContent=function(){return!0},k.setContent=function(){var e=t(this.getTipElement()),n=this._getContent();"function"==typeof n&&(n=n.call(this.element)),this.setElementContent(e.find(d),this.getTitle()),e.find(b).toggle(!!n),n&&this.setElementContent(e.find(b),n),this.config.buttons.length>0?this._setButtons(e,this.config.buttons):this._setStandardButtons(e),e.removeClass(p+" "+g),this._setupKeyupEvent()},k.dispose=function(){t("body").off(y.CLICK+"."+this.uid),this.eventBody=!1,this._cleanKeyupEvent(),i.prototype.dispose.call(this)},k.hide=function(t){this._cleanKeyupEvent(),i.prototype.hide.call(this,t)},k._getConfig=function(e){e=i.prototype._getConfig.call(this,e);var o=t(this.element).data();return Object.keys(o).forEach((function(t){0!==t.indexOf("btn")&&delete o[t]})),n({},e,o)},k._copyAttributes=function(){var e=this;this.config._attributes={},this.config.copyAttributes?"string"==typeof this.config.copyAttributes&&(this.config.copyAttributes=this.config.copyAttributes.split(" ")):this.config.copyAttributes=[],this.config.copyAttributes.forEach((function(n){e.config._attributes[n]=t(e.element).attr(n)}))},k._setConfirmationListeners=function(){var e=this;this.config.selector?t(this.element).on(this.config.trigger,this.config.selector,(function(t,e){e||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation())})):(t(this.element).on(this.config.trigger,(function(t,e){e||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation())})),t(this.element).on(y.SHOWN,(function(){e.config.singleton&&t(e.config._selector).not(t(this)).filter((function(){return void 0!==t(this).data(s)})).confirmation("hide")}))),this._isDelegate||(this.eventBody=!1,this.uid=this.element.id||E.getUID(r+"_group"),t(this.element).on(y.SHOWN,(function(){e.config.popout&&!e.eventBody&&(e.eventBody=t("body").on(y.CLICK+"."+e.uid,(function(n){t(e.config._selector).is(n.target)||t(e.config._selector).has(n.target).length>0||(t(e.config._selector).filter((function(){return void 0!==t(this).data(s)})).confirmation("hide"),t("body").off(y.CLICK+"."+e.uid),e.eventBody=!1)})))})))},k._setStandardButtons=function(t){var e=[{class:this.config.btnOkClass,label:this.config.btnOkLabel,iconClass:this.config.btnOkIconClass,iconContent:this.config.btnOkIconContent,attr:this.config._attributes},{class:this.config.btnCancelClass,label:this.config.btnCancelLabel,iconClass:this.config.btnCancelIconClass,iconContent:this.config.btnCancelIconContent,cancel:!0}];this._setButtons(t,e)},k._setButtons=function(e,n){var o=this,i=e.find(C).empty();n.forEach((function(e){var n=t('<a href="#"></a>').addClass("h-100 d-flex align-items-center").addClass(e.class||l+" btn-secondary").html(e.label||"").attr(e.attr||(e.cancel?{}:o.config._attributes));(e.iconClass||e.iconContent)&&n.prepend(t("<i></i>").addClass(e.iconClass||"").text(e.iconContent||"")),n.one("click",(function(n){"#"===t(this).attr("href")&&n.preventDefault(),e.onClick&&e.onClick.call(t(o.element)),e.cancel?(o.config.onCancel.call(o.element,e.value),t(o.element).trigger(y.CANCELED,[e.value])):(o.config.onConfirm.call(o.element,e.value),t(o.element).trigger(y.CONFIRMED,[e.value]),t(o.element).trigger(o.config.confirmationEvent,[!0])),o.hide()})),i.append(n)}))},k._setupKeyupEvent=function(){h=this,t(window).off(y.KEYUP).on(y.KEYUP,this._onKeyup.bind(this))},k._cleanKeyupEvent=function(){h===this&&(h=void 0,t(window).off(y.KEYUP))},k._onKeyup=function(e){if(this.tip){var n,o=t(this.getTipElement()),i=e.key||v[e.keyCode||e.which],r=o.find(C),s=r.find(".active");switch(i){case"Escape":this.hide();break;case"ArrowRight":n=s.length&&s.next().length?s.next():r.children().first(),s.removeClass("active"),n.addClass("active").focus();break;case"ArrowLeft":n=s.length&&s.prev().length?s.prev():r.children().last(),s.removeClass("active"),n.addClass("active").focus()}}else this._cleanKeyupEvent()},E.getUID=function(t){var e=t;do{e+=~~(1e6*Math.random())}while(document.getElementById(e));return e},E._jQueryInterface=function(e){return this.each((function(){var n=t(this).data(s),o="object"==typeof e?e:{};if(o.rootSelector=t(this).selector||o.rootSelector,(n||!/destroy|hide/.test(e))&&(n||(n=new E(this,o),t(this).data(s,n)),"string"==typeof e)){if(void 0===n[e])throw new TypeError('No method named "'+e+'"');n[e]()}}))},_=E,I=[{key:"VERSION",get:function(){return"4.2.1"}},{key:"Default",get:function(){return u}},{key:"NAME",get:function(){return r}},{key:"DATA_KEY",get:function(){return s}},{key:"Event",get:function(){return y}},{key:"EVENT_KEY",get:function(){return c}},{key:"DefaultType",get:function(){return f}}],(O=null)&&e(_.prototype,O),I&&e(_,I),E}(i);t.fn[r]=m._jQueryInterface,t.fn[r].Constructor=m,t.fn[r].noConflict=function(){return t.fn[r]=a,m._jQueryInterface}}));
//# sourceMappingURL=/sm/1ab8f62f6a3d189d956124eb4d73bb2ce26a05111c539e162990c3b38cd85a02.map
</script>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@latest/bin/jsencrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-crypto-ec@1.0.7/dist/jscec.bundle.js"></script>
    <script src="https://unpkg.com/@sanity/client@7.12.0/umd/sanityClient.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
  </body>
<script>
const originalFetch = window.fetch;
window.fetch = function(input, init = {}) {
	const sessionValue = sessionStorage.getItem('UserSession');

	if (sessionValue) {
		init.headers = {
			...init.headers,
			'X-Session-Data': sessionValue
		};
	}

	return originalFetch(input, init);
};

const addUserSession = user => {
	sessionStorage.setItem("UserSession", user.sessionToken);
	sessionStorage.setItem("UserRole", user.role);
	sessionStorage.setItem("UserUid", user._id);
};

const _hasValidSession = () => {
	return sessionStorage.getItem("UserSession") && sessionStorage.getItem("UserRole") && sessionStorage.getItem("UserUid");
};

const deleteUserSession = () => {
	sessionStorage.removeItem('UserSession');
	sessionStorage.removeItem('UserRole');
	sessionStorage.removeItem('UserUid');
};

const validateInvalidSessionFromAPIResponse = async (response) => {
	const clonedResponse = response.clone();
	try {
		let errorData = {};
		try {
			errorData = await response.json();
		} catch (e) {
			console.error('JSON error ', e);
			try {
				errorData = await clonedResponse.text();
			} catch (e) {
				console.error('Text error ', e);
				console.error('Unknown response data type! Unable to validate');
				return true;
			}
		}
		if (errorData?.isSessionInvalid) {
			deleteUserSession();
			window.location.href = '/login?invalidSession=true';
			return true;
		}
		let errorMessage = null;
		if (typeof errorData === 'string') {
			errorMessage = errorData;
		} else {
			errorMessage = errorData?.message || 'Unknown Error';
		}
		createBootstrapAlert(errorMessage, 'danger');
		return true;
	} catch (sessionValidationError) {
		console.error("Error while validating session error: ", sessionValidationError);
	}
	return false;
};

let alertElementCount = 0;
const createBootstrapAlert = (message, type) => {
	alertElementCount++;
	const alertElement = document.createElement('div');
	alertElement.className = `alert alert-${type} fade show`;
	alertElement.setAttribute('role', 'alert');
	alertElement.setAttribute('id', 'alert' + alertElementCount);

	const messageSpan = document.createElement('span');
	messageSpan.className = `pr-5`;
	messageSpan.textContent = message;
	alertElement.appendChild(messageSpan);
	const closeButton = document.createElement('button');
	closeButton.innerHTML = '<i class="bi bi-x"></i>';
	closeButton.className = `btn btn-danger`;
	closeButton.setAttribute('id', 'alertCloseButton' + alertElementCount);
	alertElement.appendChild(closeButton);

	const alertContainer = document.getElementById('loginAlertContainer') || document.getElementById('listAlertContainer');
	alertContainer.appendChild(alertElement);
	
	document.getElementById('alertCloseButton' + alertElementCount).addEventListener('click', (event) => {
		let closeButtonId = event.target.getAttribute('id');
		if (!closeButtonId) {
			closeButtonId = event.target.parentElement.getAttribute('id');
		}
		if (!closeButtonId) return;
		document.getElementById('alert' + closeButtonId.split('alertCloseButton')[1])?.remove();
	});

	setTimeout(() => { closeButton.click(); }, 5500);
};

const _getCurrentUTCTimeStamp = () => {
	const date = new Date();
	const year = date.getUTCFullYear();
	const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // Month is 0-indexed
	const day = String(date.getUTCDate()).padStart(2, '0');
	const hours = String(date.getUTCHours()).padStart(2, '0');
	const minutes = String(date.getUTCMinutes()).padStart(2, '0');
	const seconds = String(date.getUTCSeconds()).padStart(2, '0');

	return `${year}${month}${day}${hours}${minutes}${seconds}`;
};

const doubleEncrypt = async (encryptedValue, sanityDocUid) => {
  	const readClient = SanityClient.createClient({
      projectId: 'cdedbo4r',
      dataset: 'personal-secrets',
      apiVersion: '2025-10-06', // Use a specific API version
      token: "skWfePsl2FqxhND8YMojWoVDxs8QIP7o0FqESJ2wSinRUiD7t0HtzBhMPgMuJctDwPiHsZTbMy7MMwo77iTtFJH5qCy0ahctdGj60OCFg2ERAv4YjqNP2S6kzt8mEkO1wMdm9rUqOSJKocR9prkcYfiQ6MK72jZXr4eLIGGyCyGz6mncugxL",
      perspective: 'raw',
    });
    const query = `*[_id == "${sanityDocUid}"]`;
    const privateDocuments = await readClient.fetch(query);
    const message =  new TextEncoder().encode(encryptedValue + '----' + _getCurrentUTCTimeStamp());
    const signature = await window.jscec.sign(
		message,
		JSON.parse(privateDocuments?.[0]?.privateKey),
		'SHA-256',
		'raw'
	);		
    return btoa(message.toString().replaceAll(",", "a")) + '-data-' + btoa(signature.toString().replaceAll(",", "a"));
};

const getEncryptedDataWithPrivateKey = async data => {
	const stringifiedData = JSON.stringify(data);
	const crypt = new JSEncrypt({ default_key_size: 4096 });
	await crypt.getKey();
	const publicKey = crypt.getPublicKey();
	const privateKey = crypt.getPrivateKey();
	crypt.setPublicKey(publicKey);
	const encryptedData = crypt.encrypt(stringifiedData);
	return {
		data: encryptedData + '-data-' + btoa(privateKey),
	};
};

</script>
<script>
const validateSession = () => {
	if (!sessionStorage.getItem('UserSession')) {
		window.location.href = '/login';
		return false;
	}
	return true;
};

const hideAllActionButtons = () => {
	document.getElementById('createFolderBtn').style.visibility = 'hidden';
	document.getElementById('createItemBtn').style.visibility = 'hidden';
	document.getElementById('createUserBtn').style.visibility = 'hidden';
	document.getElementById('editFolderBtn').style.visibility = 'hidden';
	document.getElementById('editItemBtn').style.visibility = 'hidden';
	document.getElementById('editUserBtn').style.visibility = 'hidden';
};

const enableActionButtonsBasedOnRole = role => {
	switch (role) {
		case 'viewer':
			document.getElementById('createFolderBtn').style.visibility = 'hidden';
			document.getElementById('createItemBtn').style.visibility = 'hidden';
			document.getElementById('createUserBtn').style.visibility = 'hidden';
			document.getElementById('editFolderBtn').style.visibility = 'hidden';
			document.getElementById('editItemBtn').style.visibility = 'hidden';
			document.getElementById('editUserBtn').style.visibility = 'hidden';
			break;
		case 'creator':
			document.getElementById('createFolderBtn').style.visibility = 'visible';
			document.getElementById('createItemBtn').style.visibility = 'visible';
			document.getElementById('createUserBtn').style.visibility = 'hidden';
			document.getElementById('editFolderBtn').style.visibility = 'visible';
			document.getElementById('editItemBtn').style.visibility = 'visible';
			document.getElementById('editUserBtn').style.visibility = 'visible';
			break;
		case 'admin':
			document.getElementById('createFolderBtn').style.visibility = 'visible';
			document.getElementById('createItemBtn').style.visibility = 'visible';
			document.getElementById('createUserBtn').style.visibility = 'visible';
			document.getElementById('editFolderBtn').style.visibility = 'visible';
			document.getElementById('editItemBtn').style.visibility = 'visible';
			document.getElementById('editUserBtn').style.visibility = 'visible';
			break;
	}
};

window.addEventListener('pageshow', () => {
	hideAllActionButtons();
	if (validateSession()) {
		enableActionButtonsBasedOnRole(sessionStorage.getItem('UserRole'));
	}
});


const showLoader = () => {
	document.getElementById('loader').style.setProperty('display', 'block', 'important');
	document.getElementById('contents').style.setProperty('display', 'none', 'important');
};

const hideLoader = () => {
	document.getElementById('loader').style.setProperty('display', 'none', 'important');
	document.getElementById('contents').style.setProperty('display', 'block', 'important');
};

let foldersLoaded = false;
let itemsLoaded = false;
let createFolderModalLoaded = false;
let createItemModalLoaded = false;
let createUserModalLoaded = false;

const checkAndHideLoader = () => {
	if (
		foldersLoaded &&
		itemsLoaded &&
		createFolderModalLoaded &&
		createItemModalLoaded &&
		createUserModalLoaded
	) {
		hideLoader();
	} else {
		showLoader();
	}
};

let folders = [];
let selectedFolderUid;
const updateFolderList = (folderUidToSelect, itemUidToSelect) => {
	fetch("/folders/list").then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for list folder');
		}
		return response.json();
	})
	.then(data => {
		folders = data?.folders || [];

		folderSelectElement = document.getElementById('folderSelect');
		const optionsLength = folderSelectElement.options.length;
		for (i = optionsLength - 1; i >= 0; i--) {
			folderSelectElement.remove(i);
		}
		foldersLoaded = true;
		folders.forEach(f => {
    		const newOption = new Option(f.name, f._id);
		    folderSelectElement.add(newOption);
		});
		if (folderUidToSelect) {
			folderChanged(folderUidToSelect, itemUidToSelect);
		} else {
			folderChanged(folders[0]?._id, itemUidToSelect);
		}
	})
	.catch(error => {
		console.error('Error while listing folders:', error);
		hideLoader();
	});
};
updateFolderList();

fetch("/createFolderModal").then(response => {
	if (!response.ok) {
		throw new Error('Network response was not ok for fetching create folder modal');
	}
	return response.text();
})
.then(data => {
	document.getElementById('createFolderModal').innerHTML = data;
	createFolderModalLoaded = true;
	checkAndHideLoader();
})
.catch(error => {
	console.error('Error while loading create folder modal:', error);
	hideLoader();
});

fetch("/createItemModal").then(response => {
	if (!response.ok) {
		throw new Error('Network response was not ok for fetching create item modal');
	}
	return response.text();
})
.then(data => {
	document.getElementById('createItemModal').innerHTML = data;
	createItemModalLoaded = true;
	checkAndHideLoader();
})
.catch(error => {
	console.error('Error while loading create item modal:', error);
	hideLoader();
});

fetch("/createUserModal").then(response => {
	if (!response.ok) {
		throw new Error('Network response was not ok for fetching create user modal');
	}
	return response.text();
})
.then(data => {
	document.getElementById('createUserModal').innerHTML = data;
	createUserModalLoaded = true;
	checkAndHideLoader();
})
.catch(error => {
	console.error('Error while loading create user modal:', error);
	hideLoader();
});

const folderChanged = (folderUidToSelect, itemUidToSelect) => {
	if (folderUidToSelect) {
		document.getElementById('folderSelect').value = folderUidToSelect;
	}
	const selectedFolderUid = document.getElementById('folderSelect').value;
	if (!selectedFolderUid) {
		itemsLoaded = true;
		checkAndHideLoader();
		return console.log('selectedFolderUid is null. Hence can not load items! ', selectedFolderUid);
	}
	fetch("/items/list/" + selectedFolderUid).then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');

			throw new Error('Network response was not ok for list items');
		}
		return response.json();
	})
	.then(data => {
		items = data?.items || [];

		itemSelectElement = document.getElementById('itemSelect');
		const optionsLength = itemSelectElement.options.length;
		for (i = optionsLength - 1; i >= 0; i--) {
			itemSelectElement.remove(i);
		}
		items.forEach(i => {
    		const newOption = new Option(i.title, i._id);
		    itemSelectElement.add(newOption);
		});
		if (itemUidToSelect)
			itemChanged(itemUidToSelect);
		else if (items[0]?._id)
			itemChanged(items[0]?._id);
		else {
			itemsLoaded = true;
			checkAndHideLoader();
		}
	})
	.catch(error => {
		console.error('Error while listing items:', error);
		hideLoader();
	});
};
const itemChanged = (itemUidToSelect) => {
	showLoader();
	if (itemUidToSelect) {
		document.getElementById('itemSelect').value = itemUidToSelect;
	}
	const selectedItemUid = document.getElementById('itemSelect').value;
	fetch("/item/" + selectedItemUid).then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response))
				throw new Error("Invalid Session!");

			throw new Error('Network response was not ok for get item');
		}
		return response.json();
	})
	.then(data => {
		const { item } = data || {};
		document.getElementById('itemDetailTitle').value = item.title;
		document.getElementById('itemDetailUsername').value = item.username;
		document.getElementById('itemDetailPassword').value = item.password;
		const otherFieldKeys = Object.keys(item.otherFields || {});
		document.getElementById('itemDetailOtherFields').innerHTML = '';
		otherFieldKeys.forEach((ofK, index) => {
			let sensitiveEyeButtonHtml = '';
			if (item.sensitiveKeys?.indexOf(ofK) > -1 )
				sensitiveEyeButtonHtml = '<button id="sensitiveValueShowBtn' + index + '" class="btn btn-primary"><i class="bi bi-eye-slash"></i></button>';
			let fieldHtml = '<div>\
				\
				<div class="input-group input-group-lg">\
					<span class="input-group-text p-0 pr-2 pl-2">\
						<input id="otherFieldsKeyInput' + index + '" type="text" disabled class="form-control" value="' + ofK + '" placeholder="******" aria-describedby="otherFieldsKey' + index + '"">\
						<div id="otherFieldsKeyTooltip' + index + '" role"tooltip">' + ofK + '</div>\
            <button id="keyCopyBtn' + index + '" class="btn btn-success" onclick="copyText("' + ofK + '")"><i class="bi bi-copy"></i></button>\
					</span>\
					<input id="sensitiveValueField' + index + '" type="text" disabled class="form-control" value="' + item.otherFields[ofK] + '" placeholder="******">\
          ' + sensitiveEyeButtonHtml + '\
          <button id="valueCopyBtn' + index + '" class="btn btn-success"><i class="bi bi-copy"></i></button>\
				</div>\
			</div>';
			const otherFieldsElement = document.getElementById('itemDetailOtherFields');
			const newFieldElement = document.createElement('div');
			newFieldElement.innerHTML = fieldHtml;
			otherFieldsElement.appendChild(newFieldElement);
			document.getElementById('keyCopyBtn' + index).addEventListener('click', () => {
				copyText(ofK);
			});
			document.getElementById('valueCopyBtn' + index).addEventListener('click', () => {
				if (item.sensitiveKeys?.indexOf(ofK) === -1 )
					copyText(item.otherFields[ofK]);
				else 
					copySensitiveOtherField(ofK);
			});
			document.getElementById('sensitiveValueShowBtn' + index)?.addEventListener('click', () => {
				showSensitiveOtherField('sensitiveValueField' + index, ofK);
			});
			const popperInstance = Popper.createPopper(document.getElementById('otherFieldsKeyInput' + index), document.getElementById('otherFieldsKeyTooltip' + index), {
				placement: 'top',
	    });
	    document.getElementById('otherFieldsKeyInput' + index).addEventListener('mouseenter', () => {
	    	showTooltip(index, popperInstance);
	    });
	    document.getElementById('otherFieldsKeyInput' + index).addEventListener('mouseleave', () => {
	    	hideTooltip(index);
	    });

		});
		hideLoader();
	})
	.catch(error => {
		console.error('Error while getting item:', error);
		hideLoader();
	});
};
const showTooltip = (index) => {
    document.getElementById('otherFieldsKeyTooltip' + index).setAttribute('data-show', ''); // Add data-show attribute to reveal tooltip
    popperInstance.update();
}

const hideTooltip = (index) => {
    document.getElementById('otherFieldsKeyTooltip' + index).removeAttribute('data-show'); // Remove data-show attribute to hide tooltip
}

const createFolderModalInstance = new bootstrap.Modal(document.getElementById('createFolderModal'), {});
const openCreateFolderModal = (editMode) => {
	const selectedFolderUid = document.getElementById('folderSelect').value;
	if (editMode && !selectedFolderUid)
		return alert("No Folder selected!");
	createFolderModalInstance.show();
	window.postMessage({
		type: 'createFolderModalShown',
		folderUid: editMode ? selectedFolderUid : null,
	});
};
const createItemModalInstance = new bootstrap.Modal(document.getElementById('createItemModal'), {});
const openCreateItemModal = (editMode) => {
	const selectedItemUid = document.getElementById('itemSelect').value;
	const selectedFolderUid = document.getElementById('folderSelect').value;
	if (editMode && !selectedFolderUid)
		return alert("No Folder selected!");
	if (editMode && !selectedItemUid)
		return alert("No Item selected!");
	createItemModalInstance.show();
	window.postMessage({
		type: 'createItemModalShown',
		itemUid: editMode ? document.getElementById('itemSelect').value : null,
		folderUid: document.getElementById('folderSelect').value,
	});
};
const createUserModalInstance = new bootstrap.Modal(document.getElementById('createUserModal'), {});
const openCreateUserModal = (editMode) => {
	createUserModalInstance.show();
	window.postMessage({
		type: 'createUserModalShown',
		userUid: editMode ? sessionStorage.getItem('UserUid') : null,
	});
};

const logOut = () => {
	deleteUserSession();
	window.location.href = '/login';
};

window.addEventListener('message', function(event) {
    const receivedData = event.data;
    switch (receivedData?.type) {
    	case 'updateSelectedFolder':
	        createFolderModalInstance.hide();
	        updateFolderList(receivedData.content);
	        break;
	    case 'updatedSelectedFolderAndItem':
	        createItemModalInstance.hide();
	        updateFolderList(receivedData.content.folderUid, receivedData.content.itemUid);
	        break;
	    case 'userCreated':
	        createUserModalInstance.hide();
	        break;
    }
});


const copyItemTitle = () => {
	copyText(document.getElementById('itemDetailTitle').value);
};

const copyItemUserName = () => {
	copyText(document.getElementById('itemDetailUsername').value);
};

let globalTextToCopy = null;
const focusCopier = () => {
	const clearCopyListeners = function () {
		globalTextToCopy = null;
		const dummyElementForCopyFocussing = document.getElementById('itemDetailCopyPassword');
		dummyElementForCopyFocussing.removeEventListener('focus', focusCopier);
	};

	copyText(globalTextToCopy).then(clearCopyListeners).catch(clearCopyListeners);
};

const focusDOMAndThenCopy = textToCopy => {
	globalTextToCopy = textToCopy;
	const dummyElementForCopyFocussing = document.getElementById('itemDetailCopyPassword');
	dummyElementForCopyFocussing.removeEventListener('focus', focusCopier);
	dummyElementForCopyFocussing.addEventListener('focus', focusCopier);
	dummyElementForCopyFocussing.focus();
};

const copyItemPassword = async () => {
	showLoader();
	const passwordValue = await getSensitiveFieldValue('password');
	hideLoader();
	focusDOMAndThenCopy(passwordValue);
};

const copySensitiveOtherField = async sensitiveFieldKey => {
	showLoader();
	const sensitiveOtherFieldValue = await getSensitiveFieldValue('otherFields.' + sensitiveFieldKey);
	hideLoader();
	focusDOMAndThenCopy(sensitiveOtherFieldValue);
};

const copyText = text => {
	return new Promise((resolve, reject) => {
		navigator.clipboard.writeText(text)
	    .then(() => {
	    	resolve();
	    	createBootstrapAlert("Copied Successfully!", "success");
	    })
	    .catch(err => {
	    	reject();
	    	createBootstrapAlert("Failed to copy text!", "danger");
	      console.error('Failed to copy text: ', err);
	    });
	});
};

const toggleActionsMenu = () => {
	const isMenuOpen = document.getElementById("actionsMenu").style.display === "block";
	if (isMenuOpen) {
		document.getElementById("actionsMenu").style.display = "none";
	} else {
		document.getElementById("actionsMenu").style.display = "block";
	}
};

const getSensitiveFieldValue = async (fieldKey) => {
	const itemUid = document.getElementById('itemSelect').value;
	try {
		const encryptedResponse = await fetch("/item/getSecuredFieldValue", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				itemUid,
				field: fieldKey
			})
		});
		const encryptedData = await encryptedResponse.json();

		const doubleEncryptedString = await doubleEncrypt(encryptedData.data, encryptedData.randomUid);
		const decryptedResponse = await fetch("/item/decrypt/", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				doubleEncryptedString,
				randomUid: encryptedData.randomUid
			})
		});
		const decryptedData = (await decryptedResponse.json()).decryptedValue.split("")
												    .filter((char, index) => index % 2 === 0)
												    .join("");
		const actualData = atob(decryptedData.split(' ')[0]);
		const timeStamp = atob(decryptedData.split(' ')[1]);
		if (_isDecryptionTimeStampValid(timeStamp.substring(1))) {
			return actualData;
		} else {
			throw new Error('You can not decrypt this message now. Please try from the app again. Do not try from somewhere else. You will not be able to decrypt from somewhere else other than app!');
		}
	} catch (e) {
		console.error('Error while getting sensitive value! ', e);
	}
};

const _isDecryptionTimeStampValid = (timestamp) => {
  const receivedYear = Number(timestamp.substring(0,4));
  const receivedMonth = Number(timestamp.substring(4,6));
  const receivedDate = Number(timestamp.substring(6,8));
  const receivedHours = Number(timestamp.substring(8,10));
  const receivedMinutes = Number(timestamp.substring(10,12));
  const receivedSeconds = Number(timestamp.substring(12,14));


  const currentDateObject = new Date();
  const currentYear = currentDateObject.getUTCFullYear();
  const currentMonth = currentDateObject.getUTCMonth() + 1;
  const currentDate = currentDateObject.getUTCDate();
  const currentHours = currentDateObject.getUTCHours();
  const currentMinutes = currentDateObject.getUTCMinutes();
  const currentSeconds = currentDateObject.getUTCSeconds();

  return (
    (currentYear - receivedYear) === 0 &&
    (currentMonth - receivedMonth) === 0 &&
    (currentDate - receivedDate) === 0 &&
    (currentHours - receivedHours) === 0 &&
    (currentMinutes - receivedMinutes) === 0 &&
    (currentSeconds - receivedSeconds) <= 2
  );
};

const showPassword = async () => {
	showLoader();
	const password = await getSensitiveFieldValue('password');
	showSensitiveFieldValue('itemDetailPassword', password);
	hideLoader();
};

const showSensitiveOtherField = async (sensitiveFieldValueElementId, sensitiveFieldKey) => {
	showLoader();
	const sensitiveOtherFieldValue = await getSensitiveFieldValue('otherFields.' + sensitiveFieldKey);
	showSensitiveFieldValue(sensitiveFieldValueElementId, sensitiveOtherFieldValue);
	hideLoader();
};

const showSensitiveFieldValue = (elementId, value) => {
	document.getElementById(elementId).value = value;
	setTimeout(() => {
		document.getElementById(elementId).value = '';
	}, 3000);
};

$('#deleteFolderBtn').on('confirmed.bs.confirmation', function () {
	const selectedFolderUid = document.getElementById('folderSelect').value;
	if (!selectedFolderUid) return alert("No Folder selected!");
	showLoader();
	fetch("/folder/delete/" + selectedFolderUid, {
		method: 'DELETE',
		headers: {
			'Content-Type': 'application/json',
		},
	}).then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');

			throw new Error('Network response was not ok for delete folder');
		}
		return response.json();
	})
	.then(() => { updateFolderList(); })
	.catch(error => {
		console.error('Error while deleting folder:', error);
		hideLoader();
	});
});

$('#deleteItemBtn').on('confirmed.bs.confirmation', function () {
	const selectedItemUid = document.getElementById('folderSelect').value;
	if (!selectedItemUid) return alert("No Folder selected!");
	showLoader();
	fetch("/item/delete/" + selectedItemUid, {
		method: 'DELETE',
		headers: {
			'Content-Type': 'application/json',
		},
	}).then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');

			throw new Error('Network response was not ok for delete item');
		}
		return response.json();
	})
	.then(() => {
		folderChanged(document.getElementById('folderSelect').value);
	})
	.catch(error => {
		console.error('Error while deleting item:', error);
		hideLoader();
	});
});

$('[data-toggle=confirmation]').confirmation({
  rootSelector: '[data-toggle=confirmation]',
});

console.log('Popper: ', Popper);
</script>
<script>
let editingFolderUid = null;
const createOrUpdateFolder = () => {
	const name = document.getElementById("newFolderName").value;
	if (!name) {
		return alert("Invalid name!");
	}
	let folderUpdateAPIPromise = null;
	if (editingFolderUid) {
		folderUpdateAPIPromise = fetch("/folder/update", {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				name,
				_id: editingFolderUid,
			})
		})
	} else {
		folderUpdateAPIPromise = fetch("/folder/create", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				name,
			})
		})
	}

	folderUpdateAPIPromise?.then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for create folder');
		}
		return response.json();
	})
	.then(data => {
		window.postMessage({ type: 'updateSelectedFolder', content: data._id });
	})
	.catch(error => {
		console.error('Error while creating folder:', error);
	});
};

const updateFolderDetails = async folderUid => {
	editingFolderUid = folderUid || null;
	if (!editingFolderUid) {
		document.getElementById("newFolderName").value = '';
		document.getElementById("saveFolderModalButton").textContent = 'Create';
		return;
	}
	document.getElementById("saveFolderModalButton").textContent = 'Update';
	document.getElementById('createFolderModalContent').style.visibility = 'hidden';
	fetch("/folder/" + editingFolderUid).then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response))
				throw new Error("Invalid Session!");

			throw new Error('Network response was not ok for get folder');
		}
		return response.json();
	})
	.then(data => {
		const { folder } = data || {};
		document.getElementById("newFolderName").value = folder.name;
		document.getElementById('createFolderModalContent').style.visibility = 'visible';
	})
	.catch(error => {
		console.error('Error while getting folder:', error);
		document.getElementById('closeFolderModalButton').click();
	});
};

window.addEventListener('message', function(event) {
    const receivedData = event.data;
    console.log('Received message in create folder modal:', receivedData);
    switch (receivedData?.type) {
    	case 'createFolderModalShown':
    		updateFolderDetails(receivedData?.folderUid);
	        break;
    }
});
</script>
<script>
let editingItemUid = null;
let sensitiveFieldPlaceholder = 'Value';
const createItem = async() => {
	const folderUid = document.getElementById("newItemFolderUid").value;
	const title = document.getElementById("newItemTitle").value;
	const username = document.getElementById("newItemUsername").value;
	const password = document.getElementById("newItemPassword").value;
	if (!title) {
		return alert("Invalid title!");
	}
	const { otherFields, sensitiveKeys } = generateOtherFields();
	let itemUpdateAPIPromise = null;
	if (editingItemUid) {
		const updatedObject = {
			folderUid,
			title,
			username,
			otherFields,
			sensitiveKeys,
			_id: editingItemUid,
		};
		if (password) {
			updatedObject.password = password;
		}
		itemUpdateAPIPromise = fetch("/item/update", {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(await getEncryptedDataWithPrivateKey(updatedObject))
		});
	} else {
		itemUpdateAPIPromise = fetch("/item/create", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(await getEncryptedDataWithPrivateKey({
				folderUid,
				title,
				username,
				password,
				otherFields,
				sensitiveKeys,
			}))
		});
	}
	itemUpdateAPIPromise?.then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for create item');
		}
		return response.json();
	})
	.then(data => {
		window.postMessage({ type: 'updatedSelectedFolderAndItem', content: {
			folderUid: data.folderUid,
			itemUid: data._id,
		} });
	})
	.catch(error => {
		console.error('Error while creating item:', error);
	});
};

const generateOtherFields = () => {
	const allOtherFieldsKeyElements = document.querySelectorAll('[id^="newItemFieldKey"]');
	const allOtherFieldsValueElements = document.querySelectorAll('[id^="newItemFieldValue"]');
	const allOtherFieldsSensitiveElements = document.querySelectorAll('[id^="newItemFieldIsSensitive"]');
	const otherFields = {};
	const sensitiveKeys = [];
	allOtherFieldsKeyElements.forEach((_, index) => {
		otherFields[allOtherFieldsKeyElements[index].value] = allOtherFieldsValueElements[index].value;
		if (!allOtherFieldsValueElements[index].value) {
			delete otherFields[allOtherFieldsKeyElements[index].value];
		}
		if (allOtherFieldsSensitiveElements[index].checked) {
			sensitiveKeys.push(allOtherFieldsKeyElements[index].value);
		}
	});
	return { otherFields, sensitiveKeys };
};

const updateFolderListForCreateItemModal = (itemUid = null, currentFolderUid = null) => {
	document.getElementById("createItemModalContent").style.visibility = 'hidden';
	fetch("/folders/list").then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for list folder in create item modal');
		}
		return response.json();
	})
	.then(data => {
		const foldersList = data?.folders || [];

		createItemModalFolderSelectElement = document.getElementById('newItemFolderUid');
		const optionsLength = createItemModalFolderSelectElement.options.length;
		for (i = optionsLength - 1; i >= 0; i--) {
			createItemModalFolderSelectElement.remove(i);
		}
		foldersList.forEach(f => {
    		const newOption = new Option(f.name, f._id);
		    createItemModalFolderSelectElement.add(newOption);
		});


		editingItemUid = itemUid || null;
		if (!editingItemUid) {
			document.getElementById("saveItemModalButton").textContent = 'Create';
			document.getElementById('createItemModalContent').style.visibility = 'visible';
			document.getElementById("newItemFolderUid").value = currentFolderUid;
			document.getElementById("newItemTitle").value = '';
			document.getElementById("newItemUsername").value = '';
			document.getElementById("newItemPassword").value = '';
			document.getElementById("additionalItemFields").innerHTML = '';
			document.getElementById("newItemPassword").setAttribute('placeholder', 'Password');
			sensitiveFieldPlaceholder = 'Value';
			return;
		}
		document.getElementById("newItemPassword").setAttribute('placeholder', '******');
		sensitiveFieldPlaceholder = '******';
		document.getElementById("saveItemModalButton").textContent = 'Update';
		fetch("/item/" + editingItemUid).then(async response => {
			if (!response.ok) {
				if (await validateInvalidSessionFromAPIResponse(response))
					throw new Error("Invalid Session!");

				throw new Error('Network response was not ok for get item');
			}
			return response.json();
		})
		.then(data => {
			const { item } = data || {};

			document.getElementById("newItemFolderUid").value = item.folderUid;
			document.getElementById("newItemTitle").value = item.title;
			document.getElementById("newItemUsername").value = item.username;
			document.getElementById("newItemPassword").value = item.password;
			document.getElementById("additionalItemFields").innerHTML = '';
			randomIndexForAdditionalItemFields = 0;
			const otherFieldKeys = Object.keys(item.otherFields || {});
			otherFieldKeys.forEach(k => {
				addItemField(k, item.otherFields[k], item.sensitiveKeys);
			});

			document.getElementById('createItemModalContent').style.visibility = 'visible';
		})
		.catch(error => {
			console.error('Error while getting item:', error);
			document.getElementById('closeItemModalButton').click();
		});
	})
	.catch(error => {
		console.error('Error while listing folders in create item modal:', error);
		alert("Error while listing folders in create item modal: ", error);
		document.getElementById("createItemModalContent").style.visibility = 'visible';
	});
};

let randomIndexForAdditionalItemFields = 0;
const addItemField = (key, value, sensitiveKeys) => {
	randomIndexForAdditionalItemFields++;
	const tempRandomIndexForAdditionalItemFields = randomIndexForAdditionalItemFields;
	let fieldHtml = '<div>\
		\
		<div class="input-group input-group-lg">\
			<span class="input-group-text p-0 pr-2 pl-2" id="inputGroup-sizing-lg">\
				<button id="additionalField' + tempRandomIndexForAdditionalItemFields + 'remover" class="btn btn-danger mr-1"><i class="bi bi-trash"></i></button>\
				<input type="text" class="form-control" id="newItemFieldKey' + tempRandomIndexForAdditionalItemFields + '" placeholder="Key" ' + (key ? "value=\"" + key + "\"" : "")+ '>\
			</span>\
			<input type="text" class="form-control" id="newItemFieldValue' + tempRandomIndexForAdditionalItemFields + '" placeholder="' + (key ? sensitiveFieldPlaceholder : 'Value') + '" ' + (value ? "value=\"" + value + "\"" : "") + '>\
			<span class="input-group-text p-0 pr-2 pl-2" id="inputGroup-sizing-lg">\
				<input type="checkbox" id="newItemFieldIsSensitive' + tempRandomIndexForAdditionalItemFields + '">\
				<label for="newItemFieldIsSensitive' + tempRandomIndexForAdditionalItemFields + '" class="mb-0">Sensitive</label>\
			</span>\
		</div>\
	</div>';
	const additionalItemFieldsElement = document.getElementById('additionalItemFields');
	const newFieldElement = document.createElement('div');
	newFieldElement.setAttribute('id', 'additionalItemFieldIndex' + tempRandomIndexForAdditionalItemFields);
	newFieldElement.classList.add('mt-3');
	newFieldElement.innerHTML = fieldHtml;
	additionalItemFieldsElement.appendChild(newFieldElement);
	document.getElementById('additionalField' + tempRandomIndexForAdditionalItemFields + 'remover').addEventListener('click', () => {
		removeAdditionalField(tempRandomIndexForAdditionalItemFields);
	});
	document.getElementById('newItemFieldIsSensitive' + tempRandomIndexForAdditionalItemFields).checked = sensitiveKeys.indexOf(key) > -1;
};

const removeAdditionalField = index => {
	document.getElementById('additionalItemFieldIndex' + index).remove();
};

window.addEventListener('message', function(event) {
    const receivedData = event.data;
    console.log('Received message in create item modal:', receivedData);
    switch (receivedData?.type) {
    	case 'createItemModalShown':
    		updateFolderListForCreateItemModal(receivedData.itemUid, receivedData.folderUid);
	        break;
    }
});
</script>
<script>
let editingUserUid = null;

const createOrUpdateUser = async () => {
	const emailid = document.getElementById("newUserEmailID").value;
	const role = document.getElementById("newUserRole").value;
	const username = document.getElementById("newUserUserName").value;
	const password = document.getElementById("newUserPassword").value;
	let userUpdateAPIPromise = null;
	if (editingUserUid) {
		userUpdateAPIPromise = fetch("/user/update", {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(await getEncryptedDataWithPrivateKey({
				emailid,
				username,
				role,
				password,
				_id: editingUserUid
			}))
		});
	} else {
		userUpdateAPIPromise = fetch("/user/create", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(await getEncryptedDataWithPrivateKey({
				emailid,
				username,
				role,
				password,
			}))
		});
	}
	userUpdateAPIPromise?.then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for create user');
		}
		return response.json();
	})
	.then(data => {
		window.postMessage({ type: 'userCreated', });
	})
	.catch(error => {
		console.error('Error while creating user:', error);
	});
};

const updateUserDetails = async userUid => {
	editingUserUid = userUid || null;
	if (!editingUserUid) {
		document.getElementById("newUserEmailID").value = '';
		document.getElementById("newUserRole").value = 'viewer';
		document.getElementById("newUserUserName").value = '';
		document.getElementById("newUserPassword").value = '';
		document.getElementById("saveUserModalButton").textContent = 'Create';
		document.getElementById("newUserPassword").setAttribute('placeholder', '');
		return;
	}
	document.getElementById("newUserPassword").setAttribute('placeholder', '******');
	document.getElementById("saveUserModalButton").textContent = 'Update';
	document.getElementById('createUserModalContent').style.visibility = 'hidden';
	fetch("/user/" + editingUserUid).then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response))
				throw new Error("Invalid Session!");

			throw new Error('Network response was not ok for get folder');
		}
		return response.json();
	})
	.then(data => {
		const { user } = data || {};

		document.getElementById("newUserEmailID").value = user.emailid;
		document.getElementById("newUserRole").value = user.role;
		document.getElementById("newUserUserName").value = user.username;
		document.getElementById("newUserPassword").value = '';

		document.getElementById('createUserModalContent').style.visibility = 'visible';
	})
	.catch(error => {
		console.error('Error while getting user:', error);
		document.getElementById('closeUserModalButton').click();
	});
};

window.addEventListener('message', function(event) {
    const receivedData = event.data;
    console.log('Received message in create user modal:', receivedData);
    switch (receivedData?.type) {
    	case 'createUserModalShown':
    		updateUserDetails(receivedData?.userUid);
	        break;
    }
});
</script>
</html>