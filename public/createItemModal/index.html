<div class="m-4">
  <div id="createItemModalContent" class="modal-content">
    <div class="modal-body">
      <h3>Select the folder in which this item should reside:</h3>
      <div class="input-group input-group-lg">
        <span class="input-group-text" id="inputGroup-sizing-lg"><i class="bi bi-folder-check"></i></span>
        <select id="newItemFolderUid" class="form-select form-select-lg custom-select" aria-label=".form-select-lg example">
        </select>
      </div>
      <h3>Provide the item title:</h3>
      <div class="input-group input-group-lg">
        <span class="input-group-text" id="inputGroup-sizing-lg"><i class="bi bi-database-fill-add"></i></span>
        <input type="text" class="form-control" id="newItemTitle">
      </div>
      <h3>Item Credentials:</h3>
      <div class="input-group input-group-lg">
        <span class="input-group-text" id="inputGroup-sizing-lg"><i class="bi bi-person-bounding-box"></i></span>
        <input type="text" class="form-control" id="newItemUsername" placeholder="User Name">
      </div>
      <div class="input-group input-group-lg">
        <span class="input-group-text" id="inputGroup-sizing-lg"><i class="bi bi-lock"></i></span>
        <input type="Password" class="form-control" id="newItemPassword" placeholder="Password">
      </div>
      <hr class="bg-danger border-2 border-top border-danger" />
      <h3>Add More fields to this Item if needed:</h3>
      <button type="button" class="btn btn-success" onclick="addItemField()"><i class="bi bi-database-fill-add"></i>Add</button>
      <div id="additionalItemFields" class="container-fluid mt-3">
      </div>
    </div>
    <div class="modal-footer">
      <button id="saveItemModalButton" type="button" class="btn btn-primary" onclick="createItem()">Create</button>
      <button id="closeItemModalButton" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
  </div>
  <script>
let editingItemUid = null;
const createItem = () => {
	const folderUid = document.getElementById("newItemFolderUid").value;
	const title = document.getElementById("newItemTitle").value;
	const username = document.getElementById("newItemUsername").value;
	const password = document.getElementById("newItemPassword").value;
	if (!title) {
		return alert("Invalid title!");
	}
	let itemUpdateAPIPromise = null;
	if (editingItemUid) {
		itemUpdateAPIPromise = fetch("/item/update", {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				folderUid,
				title,
				username,
				password,
				otherFields: generateOtherFields(),
				_id: editingItemUid,
			})
		});
	} else {
		itemUpdateAPIPromise = fetch("/item/create", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				folderUid,
				title,
				username,
				password,
				otherFields: generateOtherFields(),
			})
		});
	}
	itemUpdateAPIPromise?.then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for create item');
		}
		return response.json();
	})
	.then(data => {
		window.postMessage({ type: 'updatedSelectedFolderAndItem', content: {
			folderUid: data.folderUid,
			itemUid: data._id,
		} });
	})
	.catch(error => {
		console.error('Error while creating item:', error);
	});
};

const generateOtherFields = () => {
	const allOtherFieldsKeyElements = document.querySelectorAll('[id^="newItemFieldKey"]');
	const allOtherFieldsValueElements = document.querySelectorAll('[id^="newItemFieldValue"]');
	const otherFieldsObject = {};
	allOtherFieldsKeyElements.forEach((_, index) => {
		otherFieldsObject[allOtherFieldsKeyElements[index].value] = allOtherFieldsValueElements[index].value;
	});
	return otherFieldsObject;
};

const updateFolderListForCreateItemModal = (itemUid = null, currentFolderUid = null) => {
	document.getElementById("createItemModalContent").style.visibility = 'hidden';
	fetch("/folders/list").then(async response => {
		if (!response.ok) {
			if (await validateInvalidSessionFromAPIResponse(response)) 
				throw new Error('Invalid Session');
			throw new Error('Network response was not ok for list folder in create item modal');
		}
		return response.json();
	})
	.then(data => {
		const foldersList = data?.folders || [];

		createItemModalFolderSelectElement = document.getElementById('newItemFolderUid');
		const optionsLength = createItemModalFolderSelectElement.options.length;
		for (i = optionsLength - 1; i >= 0; i--) {
			createItemModalFolderSelectElement.remove(i);
		}
		foldersList.forEach(f => {
    		const newOption = new Option(f.name, f._id);
		    createItemModalFolderSelectElement.add(newOption);
		});


		editingItemUid = itemUid || null;
		if (!editingItemUid) {
			document.getElementById("saveItemModalButton").textContent = 'Create';
			document.getElementById('createItemModalContent').style.visibility = 'visible';
			document.getElementById("newItemFolderUid").value = currentFolderUid;
			document.getElementById("newItemTitle").value = '';
			document.getElementById("newItemUsername").value = '';
			document.getElementById("newItemPassword").value = '';
			document.getElementById("additionalItemFields").innerHTML = '';
			return;
		}
		document.getElementById("saveItemModalButton").textContent = 'Update';
		fetch("/item/" + editingItemUid).then(async response => {
			if (!response.ok) {
				if (await validateInvalidSessionFromAPIResponse(response))
					throw new Error("Invalid Session!");

				throw new Error('Network response was not ok for get item');
			}
			return response.json();
		})
		.then(data => {
			const { item } = data || {};

			document.getElementById("newItemFolderUid").value = item.folderUid;
			document.getElementById("newItemTitle").value = item.title;
			document.getElementById("newItemUsername").value = item.username;
			document.getElementById("newItemPassword").value = item.password;
			document.getElementById("additionalItemFields").innerHTML = '';
			randomIndexForAdditionalItemFields = 0;
			const otherFieldKeys = Object.keys(item.otherFields || {});
			otherFieldKeys.forEach(k => {
				addItemField(k, item.otherFields[k]);
			});

			document.getElementById('createItemModalContent').style.visibility = 'visible';
		})
		.catch(error => {
			console.error('Error while getting item:', error);
			document.getElementById('closeItemModalButton').click();
		});
	})
	.catch(error => {
		console.error('Error while listing folders in create item modal:', error);
		alert("Error while listing folders in create item modal: ", error);
		document.getElementById("createItemModalContent").style.visibility = 'visible';
	});
};

let randomIndexForAdditionalItemFields = 0;
const addItemField = (key, value) => {
	randomIndexForAdditionalItemFields++;
	const tempRandomIndexForAdditionalItemFields = randomIndexForAdditionalItemFields;
	let fieldHtml = '<div>\
		\
		<div class="input-group input-group-lg">\
			<span class="input-group-text p-0 pr-2 pl-2" id="inputGroup-sizing-lg">\
				<button id="additionalField' + tempRandomIndexForAdditionalItemFields + 'remover" class="btn btn-danger mr-1"><i class="bi bi-trash"></i></button>\
				<input type="text" class="form-control" id="newItemFieldKey' + tempRandomIndexForAdditionalItemFields + '" placeholder="Key" ' + (key ? "value=\"" + key + "\"" : "")+ '>\
			</span>\
			<input type="text" class="form-control" id="newItemFieldValue' + tempRandomIndexForAdditionalItemFields + '" placeholder="Value" ' + (value ? "value=\"" + value + "\"" : "") + '>\
		</div>\
	</div>';
	const additionalItemFieldsElement = document.getElementById('additionalItemFields');
	const newFieldElement = document.createElement('div');
	newFieldElement.setAttribute('id', 'additionalItemFieldIndex' + tempRandomIndexForAdditionalItemFields);
	newFieldElement.classList.add('mt-3');
	newFieldElement.innerHTML = fieldHtml;
	additionalItemFieldsElement.appendChild(newFieldElement);
	document.getElementById('additionalField' + tempRandomIndexForAdditionalItemFields + 'remover').addEventListener('click', () => {
		removeAdditionalField(tempRandomIndexForAdditionalItemFields);
	});
};

const removeAdditionalField = index => {
	document.getElementById('additionalItemFieldIndex' + index).remove();
};

window.addEventListener('message', function(event) {
    const receivedData = event.data;
    console.log('Received message in create item modal:', receivedData);
    switch (receivedData?.type) {
    	case 'createItemModalShown':
    		updateFolderListForCreateItemModal(receivedData.itemUid, receivedData.folderUid);
	        break;
    }
});
</script>
</div>